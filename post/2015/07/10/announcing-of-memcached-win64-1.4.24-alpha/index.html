<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Memcached-win64-1.4.24-alpha 发布 - Fenying</title><link rel="icon" type="image/png" href="/logo/32x32.png?sv=1580704264" /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Memcached-win64-1.4.24-alpha 发布" />
<meta property="og:description" content="目前网络上流行的 memcached-win32 都是 1.2.x 版本，过于古老。后来在网上找到一个 1.4.5 版本的 memcached-win32 服务端程序。于是尝试自己编译一个适用于 Windows 的 memcached-1.4.24 最新版本。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fenying.github.io/post/2015/07/10/announcing-of-memcached-win64-1.4.24-alpha/" />
<meta property="article:published_time" content="2015-07-10T20:37:03+08:00" />
<meta property="article:modified_time" content="2015-07-10T20:37:03+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Memcached-win64-1.4.24-alpha 发布"/>
<meta name="twitter:description" content="目前网络上流行的 memcached-win32 都是 1.2.x 版本，过于古老。后来在网上找到一个 1.4.5 版本的 memcached-win32 服务端程序。于是尝试自己编译一个适用于 Windows 的 memcached-1.4.24 最新版本。"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://fenying.github.io/css/normalize.css?sv=1580704264" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://fenying.github.io/css/main.css?sv=1580704264" />

	<script src="https://fenying.github.io/js/feather.min.js?sv=1580704264"></script>
	
		<script src="https://fenying.github.io/js/main.js?sv=1580704264"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://fenying.github.io/">
				<img src="/logo/128x128.png?sv=1580704264" alt="Fenying" />
			</a>
		</div>
	
	<h1 class="site-title">
		<a href="https://fenying.github.io/">Fenying</a><sup class="mirror-tips">--mirror-from "<a href="https://fenying.net/">https://fenying.net/</a>"</sup></h1>
	<div class="site-description"><p>Angus&rsquo; Home.</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fenying" title="Github"><i data-feather="github"></i></a></li><li><a href="https://twitter.com/angusfenying" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://t.me/fenying" title="Telegram"><i data-feather="telegram"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/post/">Posts</a>
			</li>
			
			<li>
				<a href="/books/">Books</a>
			</li>
			
			<li>
				<a href="/tags/">Tags</a>
			</li>
			
			<li>
				<a href="/categories/">Categories</a>
			</li>
			
			<li>
				<a href="/about/">About</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
<div class="chpater-nav"><div class="nav-item prev-chapter">
            <a href="https://fenying.github.io/post/2015/09/11/warning-c4661-in-visual-c&#43;&#43;/">&lt;&lt;&lt; 关于 Visual C&#43;&#43; 里面的 warning C4661</a>
        </div><div class="nav-item next-chapter">
            <a href="https://fenying.github.io/post/2015/06/17/performance-between-in-array-and-switch-in-php/">关于 in_array 和 switch 的比较 >>></a>
        </div></div>
<hr class="chpater-nav-delimiter">

			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">10</span>
							<span class="rest">Jul 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Memcached-win64-1.4.24-alpha 发布</h1>
				</div>
			</div>
			
				
				<div class="tags">
					
						
						<a class="category" href="/categories/cache">Category: Cache</a>
						
					
					
						
						<a class="tag" title="Tag: Memcached" href="/tags/memcached">Memcached</a class="category">
						
						<a class="tag" title="Tag: Migration" href="/tags/migration">Migration</a class="category">
						
						<a class="tag" title="Tag: Windows" href="/tags/windows">Windows</a class="category">
						
					
				</div>
				
			<div class="migration">
					该文章迁移自作者的旧博客站点。<br>
					源地址：<a href="http://fenying.blog.163.com/blog/static/102055993201561083321331/" target="_blank">http://fenying.blog.163.com/blog/static/102055993201561083321331/</a>。
				</div><div class="markdown">
				
<aside class="toc">
    <p class="toc-title">目录</p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#如果想使用编译好的可执行文件">如果想使用编译好的可执行文件</a></li>
    <li><a href="#如果想尝试自行编译">如果想尝试自行编译</a></li>
    <li><a href="#安装服务">安装服务</a></li>
    <li><a href="#移植过程">移植过程</a>
      <ul>
        <li><a href="#头文件引用">头文件引用</a></li>
        <li><a href="#关于连接管理机制connections-management">关于连接管理机制（Connections Management）</a></li>
        <li><a href="#64位移植问题">64位移植问题</a></li>
        <li><a href="#缺少-linux-专有函数">缺少 Linux 专有函数</a></li>
        <li><a href="#参数命名报错">参数命名报错</a></li>
        <li><a href="#添加-deamonization">添加 Deamonization</a></li>
        <li><a href="#关闭-sals">关闭 SALS</a></li>
      </ul>
    </li>
    <li><a href="#参考文献">参考文献</a></li>
  </ul>
</nav>
</aside>



				<p>目前网络上流行的 memcached-win32 都是 1.2.x 版本，过于古老。后来在网上找到一个 1.4.5 版本的 memcached-win32 服务端程序。于是尝试自己编译一个适用于 Windows 的 memcached-1.4.24 最新版本。</p>
<p>参考了多篇文章，并对源代码做了许多适应修改。尝试了一个晚上，总算编译成功，不得不吐槽下，在 Windows 下编译 memcached 一点儿也不是件快乐的事情。目前已经发布到 GitHub，需要的朋友可以自己去查看下：<a href="https://github.com/fenying/memcached-win64">GitHub/memcached-win64</a>（包含编译好的 memcached-win64-1.4.24a.exe 以及运行库、依赖包等）。</p>
<h2 id="如果想使用编译好的可执行文件">如果想使用编译好的可执行文件</h2>
<p><a href="https://github.com/fenying/memcached-win64/blob/master/binary/memcached-win64-1.4.24-alpha.tar.gz">&raquo; memcached-win64-1.4.24.tar.gz</a>（包含运行库）</p>
<h2 id="如果想尝试自行编译">如果想尝试自行编译</h2>
<p>先说说需要哪些东西：</p>
<ul>
<li><a href="https://github.com/libevent/libevent">libevent</a> 这里用的是 <a href="https://github.com/downloads/libevent/libevent/libevent-2.0.11-stable.tar.gz">libevent-2.0.11-stable</a>。（GitHub/memcached-win64 里已包含）</li>
<li><a href="http://www.sourceware.org/pthreads-win32/">pthreads-w32</a> 这里用的是 pthreads-w32-2.9.1-x64。（GitHub/memcached-win64 里已包含）</li>
<li><a href="http://sourceforge.net/projects/mingw-w64/">MinGW-w64</a> 这里用的是 <a href="http://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Automated%20Builds/">mingw-w64-bin_i686-mingw_20111220.zip</a>。</li>
<li><a href="http://sourceforge.net/projects/mingw/files/MSYS/">msys</a>，这里使用的是 <a href="http://downloads.sourceforge.net/mingw/MSYS-1.0.11.exe">MSYS-1.0.11.exe</a>。</li>
<li><a href="https://github.com/memcached/memcached">memcached</a>，必不可缺的，当前版本是 <a href="http://www.memcached.org/files/memcached-1.4.24.tar.gz">memcached-1.4.24</a>。</li>
</ul>
<p>然后按照如下步骤编译：</p>
<ol>
<li>
<p>在 Windows 下安装 msys 1.0.11，然后配置 MinGW-w64，确保 gcc 可用。</p>
</li>
<li>
<p>从 GitHub 里把当前源代码完整拖下来，放到（msys shell 环境） 根目录 <code>/memcached-win64</code> 下。</p>
</li>
<li>
<p>将其中 <code>deps/1.4.24/libevent-2.0.11-stable-for-memcached-w64.tar.gz</code> 解压到 <code>/memcached-win64/libevent-2.0.11-stable</code>。</p>
</li>
<li>
<p>将其中 <code>deps/1.4.24/pthreads-w32_64-dll-2-9-1-release.zip</code> 解压到 <code>/memcached-win64/pthreads-w32_64-dll-2-9-1-release</code>。</p>
</li>
<li>
<p>执行如下语句：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd /memcached-win64
make clean -C libevent-2.0.11-stable
make -C libevent-2.0.11-stable

make clean -C memcached-win64
make -C memcached-win64

mkdir binary
cp memcached-win64/memcached-win64-1.4.24a.exe binary/memcached-win64-1.4.24a.exe
cp pthreads-w32_64-dll-2-9-1-release/dll/x64/pthreadGC2.dll binary/pthreadGC2.dll
</code></pre></div></li>
</ol>
<p>就可以得到编译好的 memcached.exe 了。</p>
<h2 id="安装服务">安装服务</h2>
<p>在 Windows 下，启动管理员命令行执行以下命令：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">set MEMCACHED_HOME=C:<span style="color:#a31515">\D</span>evEnv<span style="color:#a31515">\M</span>emcached
sc create Memcached binPath= <span style="color:#a31515">&#34;%MEMCACHED_HOME%\memcached.exe -d runservice -m 128&#34;</span> start= demand DisplayName= <span style="color:#a31515">&#34;Memcached Server&#34;</span>
</code></pre></div><h2 id="移植过程">移植过程</h2>
<p>我尝试移植时，参考的是 memcached-win32-1.4.5 的代码，因此和 memcached-1.4.24 有较大的区别。具体需要修改的内容如下：</p>
<h3 id="头文件引用">头文件引用</h3>
<p>去掉 Linux 专有的 SDK 头文件。</p>
<h3 id="关于连接管理机制connections-management">关于连接管理机制（Connections Management）</h3>
<p>memcached-1.4.24 内的 conns 连接池采用大数组，下标即为 socket fd，按需分配。其中使用 dup(1) 来确定 max socket fds。而在 Windows 下 dup(1) 法无效，会导致 sfd 远远超过 max_sfd，而出现 ASSERT 异常。因此将链接管理机制用 1.4.5 的替代掉。</p>
<h3 id="64位移植问题">64位移植问题</h3>
<p>64 位系统中 GCC 使用 %llu 格式化字符串会出错，需要用 PRIu64 修正。</p>
<h3 id="缺少-linux-专有函数">缺少 Linux 专有函数</h3>
<p>编译时另外的报错是 strtok_r 和 getsubopt 两个函数，这两个函数在 Windows 中不存在，因此需要到别的地方寻找。最后在 glibc 里找到了 strtok_r，在 sals 里找到了 getsubopt 。</p>
<p>此外凡是 Linux 特有的系统调用，比如信号机制，都要遮蔽掉。</p>
<h3 id="参数命名报错">参数命名报错</h3>
<p>server_socket 的第一个参数名为 interface，gcc 报错，改为 sInterface 即可。</p>
<h3 id="添加-deamonization">添加 Deamonization</h3>
<p>添加 Windows 下的 deamonization。</p>
<h3 id="关闭-sals">关闭 SALS</h3>
<p>SALS 在 Windows 下工作不正常，因此不启用它。</p>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://www.cnblogs.com/greenlee/archive/2011/02/26/1965534.html">Building Memcached on Windows</a></li>
</ul>
			</div>

			<div class="authorization authorized">
    该文章根据
    <a
        href="https://creativecommons.org/licenses/by/4.0/deed"
        target="_blank"
    >CC-BY-4.0</a>
    协议发表，转载请遵循该协议。<br>

    本文地址：https://fenying.github.io/post/2015/07/10/announcing-of-memcached-win64-1.4.24-alpha/
</div>

			<hr class="chpater-nav-delimiter">
<div class="chpater-nav"><div class="nav-item prev-chapter">
            <a href="https://fenying.github.io/post/2015/09/11/warning-c4661-in-visual-c&#43;&#43;/">&lt;&lt;&lt; 关于 Visual C&#43;&#43; 里面的 warning C4661</a>
        </div><div class="nav-item next-chapter">
            <a href="https://fenying.github.io/post/2015/06/17/performance-between-in-array-and-switch-in-php/">关于 in_array 和 switch 的比较 >>></a>
        </div></div>
<div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'fenying';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>
			Last updated on 2020-02-03 |
			 © Copyright 2020 Angus Fenying  |
			Power by <a href="https://gohugo.io/" target="_blank" title="Hugo">Hugo</a> |
			With theme <a href="https://github.com/fenying/hugo-ink" target="_blank">Ink</a> |
			<a href="/sitemap.xml">Site Map</a>
		</div>
	</nav>
</div><script>feather.replace()</script>
</body>
</html>
